<link rel="import" href="../bower_components/polymer/polymer.html">
<script type="text/javascript" src="../sockjs/sockjs.js"></script>
<script type="text/javascript" src="../vertxbus/vertxbus.js"></script>

<polymer-element name="vertx-eventbus" attributes="url pingInterval registerHandlers autoReconnect">
    <script>
    Polymer('vertx-eventbus', {

      url: null,
      pingInterval: null,
      registerHandlers: null,
      autoReconnect: false,
      eventBus: null,
      isConnect: false,

      urlChanged: function() {
        this.connect();
      },

      connect: function() {
        this.eventBus = new vertx.EventBus(self.url, {vertxbus_ping_interval: self.pingInterval});
        this.eventBus.onopen = function() {
            self.isConnected = true;
            self.fire('open');
            self.registerHandlers.forEach(function(regHandler) {
                eb.registerHandler(regHandler.address, regHandler.function);
            });
        };

        this.eventBus.onclose = function() {
            self.isConnected = false;
            self.registerHandlers.forEach(function(regHandler) {
                eb.unregisterHandler(regHandler.address, regHandler.function);
            });
            self.fire('close');
        };
      },

      ready: function () {
        var self = this;
        self.isConnected = false;

        this.connect();
      }
    });
  </script>
</polymer-element>
